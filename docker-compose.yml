version: '3.8'

services:
  # Redis服务（后端Celery依赖，增加持久化）
  redis:
    image: redis:7-alpine
    container_name: testrunner_redis
    restart: always
    networks:
      - testrunner_network
    volumes:
      - redis_data:/data  # 持久化Redis数据，避免重启丢失
    command: redis-server --appendonly yes  # 开启AOF持久化

  # 后端主服务（Gunicorn + 环境变量补全）
  backend:
    image: ghcr.io/lucky-testrunner/testrunner-backend:latest
    container_name: testrunner_backend
    restart: always
    environment:
      - DJANGO_DEBUG=True
      - SECRET_KEY=django-insecure-xxxxxxxxx  # 替换为随机生成的密钥（必填）
      - ALLOWED_HOSTS=backend,localhost,127.0.0.1  # 允许的访问域名
      - DB_ENGINE=django.db.backends.sqlite3
      - DB_NAME=/app/data/testrunner.db
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=django-db  # 匹配项目celery.py配置
      - DJANGO_SETTINGS_MODULE=TestRunner.settings
    volumes:
      - sqlite_data:/app/data
      - ./TestRunner_Django/logs:/app/logs  # 挂载日志目录（可选）
    depends_on:
      - redis
    networks:
      - testrunner_network
    command: >
      sh -c "
      # 初始化数据库（首次启动执行）
      python manage.py migrate --noinput;
      # 启动Gunicorn（替代runserver，生产级WSGI服务器）
      gunicorn TestRunner.wsgi:application --bind 0.0.0.0:8000 --workers 4 --threads 2;
      "

  # Celery Worker（异步任务处理，项目核心依赖）
  celery_worker:
    image: ghcr.io/lucky-testrunner/testrunner-backend:latest
    container_name: testrunner_celery_worker
    restart: always
    environment:
      - DJANGO_DEBUG=True
      - SECRET_KEY=django-insecure-xxxxxxxxx  # 与后端保持一致
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=django-db
      - DJANGO_SETTINGS_MODULE=TestRunner.settings
    volumes:
      - sqlite_data:/app/data
    depends_on:
      - redis
      - backend
    networks:
      - testrunner_network
    command: celery -A TestRunner worker --loglevel=info --pool=solo  # Windows兼容池，Linux可换prefork

  # Celery Beat（定时任务，如清理过期测试结果）
  celery_beat:
    image: ghcr.io/lucky-testrunner/testrunner-backend:latest
    container_name: testrunner_celery_beat
    restart: always
    environment:
      - DJANGO_DEBUG=True
      - SECRET_KEY=django-insecure-xxxxxxxxx  # 与后端保持一致
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=django-db
      - DJANGO_SETTINGS_MODULE=TestRunner.settings
    volumes:
      - sqlite_data:/app/data
    depends_on:
      - redis
      - backend
    networks:
      - testrunner_network
    command: celery -A TestRunner beat --loglevel=info

  # 前端服务（8088端口暴露，配置反向代理解决跨域）
  frontend:
    image: ghcr.io/lucky-testrunner/testrunner-frontend:latest
    container_name: testrunner_frontend
    restart: always
    ports:
      - "8088:80"  # 仅暴露8088端口，符合需求
    depends_on:
      - backend
    networks:
      - testrunner_network
    # 覆盖Nginx配置，添加后端API反向代理（解决跨域）
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    # 移除本地代码挂载（避免覆盖镜像内编译产物）

# 网络配置
networks:
  testrunner_network:
    driver: bridge

# 数据卷配置（增加Redis持久化）
volumes:
  sqlite_data:
    driver: local
  redis_data:
    driver: local